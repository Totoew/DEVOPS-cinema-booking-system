# Образ решения

## Бизнес-требования

**Цель продукта** - предоставить пользователям возможность выбирать сеансы и места, оплачивать и получать бронирования онлайн

**Целевая аудитория** - посетители кинотеатра 16+ с базовыми навыками работы с веб и моб браузерами

**Бизнес-метрики** - конверсия регистрации в первую покупку, конверсия выбора сеанса в оплату, количество возвратов, средний чек, доля неуспешных оплат

**Основные процессы** - каталог фильмов и афиша - выбор сеанса и мест - оплата - подтверждение и история заказов

**Ограничения** - один заказ не может включать места из разных сеансов - оплата моделируется тестовым шлюзом без списаний

## Пользовательские требования

### Роли
- Гость - может видеть афишу и карточки фильмов, не может создавать заказы и видеть историю
- Пользователь - после входа может выбирать сеансы и места, оформлять заказ, оплачивать, просматривать историю, выходить из аккаунта
- Администратор афиши - не реализован в интерфейсе; данные предзаполнены

### Регистрация и вход
- Экран входа - поля: email, пароль; кнопка входа; ссылка перехода на регистрацию
- Экран регистрации - поля: email, пароль; кнопка создания аккаунта; ссылка перехода на вход
- Валидации полей:
  - email - обязателен, корректный формат, уникален
  - пароль - обязателен, минимальная длина 8
- Ошибки показываются текстом над формой (например: неверные учетные данные, email уже существует)
- После успешной регистрации - переход на вход; после успешного входа - переход на афишу
- Сессия хранится в браузере (token); при наличии токена доступ к защищенным страницам разрешен
- Кнопка «Выйти» доступна на защищенных экранах; при нажатии запрашивается подтверждение; при согласии - удаление токена и переход на вход

### Афиша (каталог фильмов)
- Отображение карточек фильмов сеткой
- Карточка содержит: постер, название, жанр, длительность, рейтинг, кнопку «Выбрать сеанс»
- По кнопке - переход к списку сеансов выбранного фильма
- Требования по UX:
  - Постер адаптивный, заполняет верхнюю часть карточки
  - Кнопка доступна с клавиатуры, фокус видим
  - Пустое состояние (если фильмов нет) - информативный текст

### Сеансы
- Страница списка сеансов выбранного фильма
- Для каждого сеанса отображаются: дата и время начала (`startUtc`), зал (`hall`), цена (`price`)
- По клику на сеанс - переход на схему зала соответствующего шоу

### Схема зала и выбор мест
- Прямоугольная схема мест с рядами и номерами кресел
- Состояния места: свободно, занято, выбрано
- Действия:
  - Выбрать/снять выбор кликом по свободному месту
  - Добавление/удаление места отражается в блоке "Выбранные места"
- Ограничения: максимум 10 мест в одном заказе
- Кнопка "Перейти к оплате" активна при наличии хотя бы одного выбранного места
- Поле ввода промокода на этом шаге; при невалидном коде показывается сообщение; при валидном суммарная стоимость обновляется на этапе оплаты

### Оформление и оплата
- Содержимое экрана:
  - Сумма к оплате с учетом количества мест, цены сеанса, сервиса и скидки
  - Поля формы: номер карты, месяц, год, CVV, имя на карте
  - Кнопка "Оплатить"
- Валидации:
  - Номер карты - 16 цифр, допускается ввод с пробелами; отображается в формате групп по 4
  - Месяц - 01..12; Год - две цифры; срок не в прошлом
  - CVV - 3 цифры
  - Имя на карте - не пустое
- Ошибки отображаются под полями и общим сообщением над формой
- При успешной оплате - сообщение об успехе и переход в «Мои заказы»
- При отказе - читаемое описание причины (например: недостаточно средств, карта заблокирована)

### История заказов (Мои заказы)
- Доступ только после входа
- Таблица с колонками: ID заказа, сеанс, места, статус, сумма
- Список показывает только заказы текущего пользователя
- Пустое состояние - информативное сообщение

### Навигация и доступность
- Страницы: вход, регистрация, афиша, сеансы, схема зала, оплата, мои заказы
- Защищенные маршруты: сеансы, схема зала, оплата, мои заказы (требуется токен)
- Управление клавиатурой и видимый фокус на интерактивных элементах

## Системные требования - функциональные

### Каталог фильмов
- Список со страницей подробностей фильма
- Постер
- Жанр
- Длительность
- Возрастной рейтинг

### Сеансы
- Дата и время
- Зал
- Цена
- Статус доступности

### Схема зала
- Прямоугольная сетка мест с признаками занятости
- Выбор нескольких мест
- **Дополнительно**: максимум 10 мест на заказ, визуальные состояния: свободно/занято/выбрано

### Корзина
- Перечень выбранных мест с суммой
- Очистка корзины

### Оплата
- Форма с полями номер карты - срок - cvc - имя на карте
- Имитация успешного и неуспешного сценариев
- Валидации: карта 16 цифр, срок не в прошлом, итог считается числом: базовая цена × количество + сервисный сбор − скидка, итог не меньше нуля

### Регистрация и вход
- Email
- Пароль
- Минимальная длина пароля 8
- **Дополнительно**: уникальность email, формат валидации

### История заказов
- Список заказов пользователя с номером - датой - суммой - статусом
- Доступ только авторизованным пользователям и только собственные заказы

## API

- `POST auth/register`
- `POST auth/login`
- `GET movies`
- `GET shows?movieId=` - `GET shows/:id`
- `GET seats/:showId`
- `POST order`
- `GET orders`
- `POST payment/charge` 

### Требования к API
- POST order требует Authorization 
- GET orders требует Authorization, возвращает только заказы текущего пользователя 
- Валидации карты и суммы в payment/charge
- HTTP статусы: 400 (невалидные данные), 401 (нет токена), 404 (не найдено), 409 (конфликт бронирования)

## Данные

### Пользователи
- Email уникален
- **Структура**: email, passwordHash

### Фильмы
- id - title - durationMin - rating - description
- **Дополнительно**: genre для отображения

### Сеансы
- id - movieId - startUtc - hall - price

### Места
- showId - seatNumber - isBooked

### Заказы
- id - userEmail - showId - seats[] - amount - createdUtc - status

## Нефункциональные требования

### Производительность
- Список фильмов до 50 записей загружается менее 2 секунд при нормальной сети
- Выбор мест откликается менее 200 мс локально

### Совместимость
- Chrome - Firefox - Safari - Edge последних версий
- Мобильные браузеры iOS и Android

### Безопасность
- Токен аутентификации обязателен для создания заказа и просмотра истории
- Пароль хранится невосстановимо хэшированным

### Надежность
- В случае ошибки оплаты заказ не создается
- При конфликте бронирования пользователь получает понятное сообщение

### Юзабилити
- Недоступные места визуально отличимы
- Поля оплаты имеют валидацию формата

### Локализация
- Русский интерфейс

### Промокоды для тестирования
- **STUDENT** - скидка 20%, лимит 100 использований
- **FRIDAY50** - скидка 50%, лимит 50 использований  
- **FREE** - скидка 100%, лимит 5 использований

### API для управления промокодами и картами
- **POST /admin/promo** - создать промокод
  - Поля: `code` (строка), `discountPercent` (0-100), `maxUses` (опционально, число)
  - Ответ 409 если промокод уже существует
- **GET /admin/promo** - получить список всех промокодов
- **POST /admin/testcard** - создать тестовую карту
  - Поля: `number` (16-значный номер или произвольный для тестов), `balance` (число), `status` (`active` | `blocked` | `expired`), `holderName` (опционально)
- **GET /admin/testcard** - список всех тестовых карт
- **PUT /admin/testcard/:number** - обновить баланс или статус карты


### Инструкция по тестированию

**Тестирование промокодов:**
1. На шаге выбора мест введите один из кодов: `STUDENT`, `FRIDAY50`, `FREE`
2. Неверный код должен давать сообщение об ошибке (на клиенте)
3. Проверяйте изменение суммы заказа на шаге оплаты

**Тестирование карт:**
1. Успешная оплата: карта `4111 1111 1111 1111`, месяц `12`, год `30`, CVV `111`
2. Недостаточно средств: карта `4000 0000 0000 0010`, любой валидный срок (например, MM `12`, YY `30`), CVV `111`
3. Карта заблокирована: карта `4000 0000 0000 0028`, любой валидный срок, CVV `111`
4. Карта просрочена: карта `4000 0000 0000 0036`, укажите срок в прошлом (например, MM `01`, YY `<текущий год - 1>`), CVV `111`

**Управление тестовыми данными через API:**
```bash
# Создать новую карту
curl -X POST http://localhost:4000/admin/testcard \
  -H "Content-Type: application/json" \
  -d '{"number":"4000000000000044","balance":2000,"status":"active"}'

# Создать промокод
curl -X POST http://localhost:4000/admin/promo \
  -H "Content-Type: application/json" \
  -d '{"code":"NEW10","discountPercent":10,"maxUses":5}'

# Изменить баланс карты
curl -X PUT http://localhost:4000/admin/testcard/4000000000000002 \
  -H "Content-Type: application/json" \
  -d '{"balance":1500}'

# Заблокировать карту
curl -X PUT http://localhost:4000/admin/testcard/4000000000000002 \
  -H "Content-Type: application/json" \
  -d '{"status":"blocked"}'
```



